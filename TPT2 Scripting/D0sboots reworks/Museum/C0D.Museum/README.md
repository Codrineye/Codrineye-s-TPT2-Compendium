# Source Export

```
{"workspaces":{"C0D.Museum":[["COD.Museum lib","; Standardized package naming accross all scripts\n#package(name) C0D.Museum v1.0:{name}\n\n; Key to toggle the script on and off\n#start m\n\n\n; scripts status, a boolean that starts a hiding block\n; true if we're active\n; false if we're idle\n#status \"<size=0>%ms#\"\n\n; how many characters are used to reprezent an element?\n#element_size 2\n{lua(\\\n  --[[list of all elements]]\\\n  local elements = table.pack(\\\n    \"light\",    \"electricity\", \"fire\",\\\n    \"darkness\", \"nature\",      \"air\",\\\n    \"water\",    \"earth\",       \"universal\"\\\n  );\\\n  \\\n  local element_format = \"%-{element_size}s\";\\\n  local elems;\\\n  do\\\n    local acc = {};\\\n    for i = 1, #elements do\\\n      local element = element_format:format(elements[i]);\\\n      acc[i] = element:sub(1, {element_size});\\\n    end\\\n    --[[builds our elements list in the array acc]]\\\n    elems = table.concat(acc);\\\n  end\\\n  \\\n  Museum = {};\\\n  function Museum.offset_elems(offset)\\\n    local size = #elems + offset;\\\n    local fmt = [[\"%]] .. size .. [[s\"]];\\\n    return string.format(fmt, elems);\\\n  end\\\n)}\n\n; Turn an element string into an index. For our purpose, all the indexes\n; need to be multiplied by two, so we look for the index of the first two\n; characters of the element.\n; The \"offset\" number allows us to concatenate on a string and thus add a\n; constant offset to the result.\n#element_to_index_base(ele, offset) index(\\\n  {lua(return Museum.offset_elems({offset}))}, \\\n  sub({ele}, 0, {element_size}), \\\n  0\\\n)\n\n; Determine the number of tiers we can boost given our budget\n; and stones of \"in_tier\"\n; We allocate 1% of budget for each stone. Based on the tier of stones\n; we can buy, they cost 2000 * 18 ^ in_tier / 18 each\n; (We ignore the extra cost of universal stones.)\n; This determines how many stones we can buy, and thus the max tier.\n; The floor and the extra division by 9 mean that, if the level\n; can't be raised by at least 2 levels, the quantity in the log will\n; be rounded down to 0, and thus, the log will result in -infinity.\n; We add back the 2 levels on the outside.\n#up_tiers(in_tiers) 2.0 + floor(\\\n  resource(\"museum.resources\") / (2e5 * 9.0 / 18.0) / (18.0 ^ ({in_tiers}))\\\n) // 3.0\n\n; The top tier that can be achieved, given input stones of \"in_tier\".\n; Capped either at +14 levels, or by the budget function in up_tiers.\n; If we can't reach +2 levels, up_tiers returns -inf,\n; which will result in -1 from this function.\n#top_tier(in_tier) min(50.0, max(-1.0, ({in_tier}) + min(\\\n  14.0,\\\n  {up_tiers({in_tier})}\\\n)))\n"],["Museum Goal","; The goal is to try an uptier all stones in the loadout\n;\n; We use museum_slot to traverse the loadout (which is indexed by 0)\n; Once we find a slot with a stone, we clear our inventory and place it in slot 0 of the inventory\n; The inventory has 30 slots and it takes 3 stones of the same tier to combine in 1 tier higher\n; Thus, we have (30 - 1) free slots and divide them by (3 - 1) stones to uptier = 29 / 2\n; 29 / 2 = 14.5 = 14 uptiers (since the stone tier is an integer)\n;\n; the function combine requires the user to unlock the skill `quick combine`\n; Combine starts from slot 0 and looks for the next 3 stones of the same tier,\n; then it combines them and places the result at the empty slot in the inventory, thus\n; we can guarantee that the highest tier stone is in slot 0\n;\n;\n; The primary goal is to fill our inventory\n"],["Museum Game-Plan","; How to museum\n;\n; The script will only ever buy stones from the offshore market (if unlocked).\n; The formula to calculate the cost to buy a tier from the offshore market = `2000 * 18 ^ tier`\n;\n; Since we can now have the exact number of museum resources on hand, we no longer have to wait\n; because of a lack of budget, as it can simply uptier the ammount that it needs.\n;\n;\n; Similar to the original script by d0sboots. We need to keep a list of offer tiers, but this time\n; since we no longer have to include that lack of budget fail state, the offer_tiers list will\n; need to hold more tiers.\n; The new encoding would be stone element, followed by a length-1 0 through 9 marker that represents\n; how many offers we found for that element (n - 1), and then\n; n-1 length-2 chunks that hold the offer tiers.\n; If no such offers were found, the entry will not exist.\n;\n; We'll need to order these lists from highest to lowest, so that we can get the highest to lowest\n; prices. Since we also want to minimise the number of global variables created, these must all be\n; within the same variable.\n;\n; For the sake of efficiency, there'll also need to be a cutoff point, where it'd be more beneficial\n; to buy a lower tier stone instead of a higher tier stone. Idealy, this would only need to happen\n; when we can't buy enough of the highest tier to uptier for a higher combination, but buying\n; a lower tier could also just make things worse.\n;\n; For future work, it'd be the best to determine if clearing the inventory would still be needed.\n"],["Main",":import COD.Museum lib\n:name {package(Main)}\n:budget_cap 10000\n\n; The main script of the script.\n; This is responsible for updating the scripts UI, filling up the users inventory with stones\n; and for combining the stones together.\n;\n; The UI is controlled by the global \"museum_status\", which tells the user what the script is doing\n; and also stops the hiding block started by our script status defined in the lib\n\n:import budget exec_lib\n; Import budget exec_lib so we can accelerate our budget\n\n:local double museum_time\n\n:global int museum_slot ; target slot in the loadout\n:global int museum_tier ; tier of stones we have in our inventory\n:global int target_tier ; tier we're trying to uptier to\n:global int instances   ; number of instances created\n;\n:local int offer_idx ; index of offer in the offshore market we're analyzing\n;\n:global string offer_tiers ; string holding the offer tiers\n:global string museum_status\n\n\n;|======================================================================|\n;|-----------------------------START MACROS-----------------------------|\n;|======================================================================|\n\n; Macro-substitution for the museum timer,\n; allows mocking it out easily for testing.\n#timer museum.timer()\n\n; Normally we would take the ceiling of the time remaining,\n; because that's how timers work.\n; (You show 1 second left until the time hits 0.0)\n; However, the display timer in the museum uses floor,\n; and we want to match that, so we use floor too.\n; The parameter is a divisor, to make dealing with minutes easier.\n#time_floor(offset) floor({timer} / ({offset} * 10.0)) % 6.0\\\n                  . floor({timer} / {offset}) % 10.0\n\n\n; Turn an element string into an index.\n; The base version is defined in the lib macros.\n#element_to_index(offset) {element_to_index_base(museum.slotElement(offer_idx), {offset})}\n\n;|======================================================================|\n;|-----------------------------START SCRIPT-----------------------------|\n;|======================================================================|\n\n; try to show the UI when facility AI activates\nwakeup()\n\n; Update the UI when we enter the museum\nopen.museum()\nclose.museum()\n\n; Toggle the script state\nkey.{start}()\n\n; start the hiding block and toggle our state\nglobal.bool.set({status}, global.bool.get({status}) != (impulse() == \"key.{start}\"))\n\ntop:\ninstances = 0\n\nmuseum_tier = -1\nmuseum_slot = -1\ntarget_tier = -1\n\n; 01 for all elements\n; -1 for universal as it can only be bought from the offshore market\noffer_tiers = \"0101010101010101-1\"\n\n; Time for some ugly math!\n; When we set preferred tier to \"pref\", we set stones in the range [pref - 10, pref], at uniform.\n; We want our best stone to be in that range minus the one that we can *just* afford to do\n; +14 levels from. Stones smaller than that fall off at a rate of 1 tier/level, and stones\n; higher fall off at a rate of (18 log 3 - 1) ~1.63 tiers/level.\n; To maximize the potential of the range, we want the top and bottom of the range to have\n; equally high max_tiers, so max_tier(pref - 10.5) = max_tier(pref + 0.5).\n;\n; The halves make the range of size 11, which is needed\n; to propperly match the actual integer-sized range\n;\n; Key points:\n; We allocate 1% budget to every stone\n; The formula to calculate the cost to buy a tier from the offshore market = `2000 * 18 ^ tier`\n; Thus, we'll need a budget of 2000 * 100 * 18 ^ (tier - 1) to uptier from that tier\n; We uptier from tier 1\n; Substituting gives:\n; K = 2e5 / 18\n; pref - 10.5 + 14 = log_3((budget / K) / 18 ^ (pref + 0.5)) + pref + 0.5\n; pref - pref + 14 - 10.5 - 0.5 = log_3((budget / K) / 18 ^ (pref + 0.5))\n; 0 + 3 = log_3((budget / K) / 18 ^ (pref + 0.5))\n; log_3(3 ^ 3) = log_3((budget / K) / 18 ^ (pref + 0.5))\n; 27 = (budget / K) / 18 ^ (pref + 0.5)\n; 18 ^ (pref + 0.5) = (budget / K) / 27\n; log_18(18 ^ (pref + 0.5)) = log_18((budget / K) / 27)\n; pref + 0.5 = log_18((budget / K) / 27)\n; pref = log_18((budget / K) / 27) - 0.5\n; pref = log_18((budget / K) / 27 / 18 ^ 0.5)\n; pref = log_18(budget * 18 ^ 0.5 / 27 * K)\n; pref = log_18(budget * 18 ^ 0.5 / (27 * 2e5 / 18))\n; pref = log_18(budget * 18 ^ 0.5 / 54e5)\n;\nmuseum.setPreferredTier(max(1, min(\\\n  50,\\\n  d2i((resource(\"museum.resources\") * ((18.0 ^ 0.5) / 54e5)) // 18.0)\\\n)))\n\n; click to enter the Artifacts menu\n{click.relative(150.0 / 800.0, 280.0 / 450.0, 0.0, 1.0)}\n\nupdate_status:\n; Stop the hiding block\n; If we got an error, don't let us through\nmuseum_status = if(\\\n  contains(museum_status, \"ERROR=\"),\\\n  museum_status,\\\n  \"</size>\" . if(\\\n    global.bool.get({status}) || (\\\n      global.string.get(budget_exec_var) == \"</size>\" &&\\\n      (museum_slot != -1 && freeSlots(\"inventory\") == 30) &&\\\n      museum_slot == -1 && budget() >= 98000\\\n    ),\\\n    \"museum=\" . if(\\\n      global.bool.get({status}),\\\n      \"<color=#FF0>Combining... [\" . museum_slot + 1 . \"]</color>\",\\\n      \"\"\\\n    ) . \"<br><color=#2F4>{start}</color> <color=#0DF>\" . if(\\\n      global.bool.get({status}),\\\n      \"stops\",\\\n      \"begins\"\\\n    ),\\\n    \"<color=red>ERROR=\" . if(\\\n      global.string.get(budget_exec_var) != \"</size>\",\\\n      \"{accelerate_budget} \" . if(\\\n        global.string.get(budget_exec_var) == \"\",\\\n        \"IS NOT RUNNING!\",\\\n        \"HAS AN UNKNOWN STATUS!<br>An active script has modified it!\"\\\n      ),\\\n      if(\\\n        museum_slot != -1 && freeSlots(\"inventory\") < 30,\\\n        \"Script cannot be run!<br>Inventory must have 30 slots!\",\\\n        \"Insufficient Budget!<br>Upgrade Server RAM in HQ!\"\\\n      )\\\n    )\\\n  ) . \"</color>\"\\\n)\n\n; shut down the script if we got an error\nglobal.bool.set({status}, global.bool.get({status}) && not(contains(museum_status, \"ERROR=\")))\n\n; unset if the museum isn't open\n; Move to the next slot if we're active or terminate the program if we're shut down\ngoto(if(\\\n  isopen(\"museum\"),\\\n  if(global.bool.get({status}), next_slot, 99),\\\n  unset\\\n))\n\nstart_waiting:\n; Click to enter the Power Stones menu\n{click.relative(150.0 / 800.0, 325.0 / 450.0, 0.0, 1.0)}\n\nwaiting:\n; Start the waiting loop\n; This is entered when museum_slot becomes 130 and is reset\n\nmuseum_time = max(1.0, if(isopen(\"museum\"), {timer}, 0.0)) - 1.0\nmuseum_status = \"</size>museum=<color=#2F4>{start}</color> <color=#0DF>\" . if(\\\n  global.bool.get({status}),\\\n  \"stops</color><br><color=#FFF>Waiting \"\\\n  . {time_floor(60.0)} . \":\"\\\n  . {time_floor(1.0)},\\\n  \"starts\"\\\n) . \"</size>\"\n\nwaitwhile({timer} > museum_time)\n\n; \ngoto(if(\\\n  isopen(\"museum\"),\\\n  if(global.bool.get({status}) && museum_time > 0.0, waiting, top),\\\n  unset\\\n))\n\nnext_slot:\n\n; Try to swap the tile we've just uptiered\n; If we didn't uptier a tile, we do nothing outside of using up 100 budget\nmuseum.swap(\\\n  \"inventory\",\\\n  0,\\\n  if(tier(\"inventory\", 0) == -1, \"inventory\", \"loadout\"),\\\n  museum_slot\\\n)\n\n; Make space in our inventory and move to the next slot\nclear(\"inventory\")\nmuseum_slot += 1\n\nget_offers:\n\n\nskip_offers:\n\nunset:\nmuseum_status = \"\""]]}}
```

